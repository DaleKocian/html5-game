<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
    <title>Space Demo</title>
    <link href="stylesheets/screen.css" media="all" rel="stylesheet" type="text/css"/>
    <script language="javascript"
            src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js" type="text/javascript"></script>
    <script language="javascript" src="javascripts/jquery.hotkeys.js" type="text/javascript"></script>
    <script language="javascript" src="javascripts/key_status.js" type="text/javascript"></script>
    <script language="javascript" src="javascripts/util.js" type="text/javascript"></script>
    <script language="javascript" src="javascripts/sprite.js" type="text/javascript"></script>
    <script language="javascript" src="javascripts/sound.js" type="text/javascript"></script>
</head>
<body>
<h1>Space Demo</h1>
<script type='text/javascript'>
//<![CDATA[
var CANVAS_WIDTH = 960;
var CANVAS_HEIGHT = 640;
var FPS = 30;
var PLAYER_UP = "player-up";
var PLAYER_DOWN = "player-down";
var PLAYER_LEFT = "player-left";
var PLAYER_RIGHT = "player-right";


var player = {
    color:"#00A",
    x:50,
    y:550,
    width:38,
    height:53,
    draw:function () {
        canvas.fillStyle = this.color;
        canvas.fillRect(this.x, this.y, this.width, this.height);
    }
};

var playerBullets = [];

function Bullet(I) {
    I.active = true;
    determineBulletDirection(I, player.oldSprite);
    I.width = 3;
    I.height = 3;
    I.color = "#000";

    I.inBounds = function () {
        return I.x >= 0 && I.x <= CANVAS_WIDTH &&
                I.y >= 0 && I.y <= CANVAS_HEIGHT;
    };

    I.draw = function () {
        canvas.fillStyle = this.color;
        canvas.fillRect(this.x, this.y, this.width, this.height);
    };

    I.update = function () {
        I.x += I.xVelocity;
        I.y += I.yVelocity;

        I.active = I.active && I.inBounds();
    };

    I.explode = function () {
        this.active = false;
        // Extra Credit: Add an explosion graphic
    };

    return I;
}

function determineBulletDirection(I, playerPosition) {
    if (playerPosition == PLAYER_UP) {
        I.xVelocity = 0;
        I.yVelocity = -I.speed;
    } else if (playerPosition == PLAYER_DOWN) {
        I.xVelocity = 0;
        I.yVelocity = I.speed;
    } else if (playerPosition == PLAYER_LEFT) {
        I.xVelocity = -I.speed;
        I.yVelocity = 0;
    } else if (playerPosition == PLAYER_RIGHT) {
        I.xVelocity = I.speed;
        I.yVelocity = 0;
    }
}

enemies = [];

function setEnemyStartingPoint(I) {
    var r = Math.floor(Math.random() * 4) + 1;
    I.x = CANVAS_WIDTH / 4 + Math.random() * CANVAS_WIDTH / 2;
    I.y = CANVAS_HEIGHT / 4 + Math.random() * CANVAS_HEIGHT / 2;
    switch (r) {
        case 1:
            I.y = 0;
            break;
        case 2:
            I.x = 0;
            break;
        case 3:
            I.x = CANVAS_WIDTH;
            break;
        default:
            I.y = CANVAS_HEIGHT;
            break
    }
    return I;
}

function Enemy(I) {
    I = I || {};

    I.active = true;
    I.age = Math.floor(Math.random() * 128);

    I.color = "#A2B";

    setEnemyStartingPoint(I);

    I.xVelocity = 0;
    I.yVelocity = 2;

    I.width = 32;
    I.height = 75;

    I.inBounds = function () {
        return I.x >= 0 && I.x <= CANVAS_WIDTH &&
                I.y >= 0 && I.y <= CANVAS_HEIGHT;
    };

    I.sprite = Sprite("enemy");

    I.draw = function () {
        this.sprite.draw(canvas, this.x, this.y);
    };

    I.update = function () {
        if (I.x > player.x) {
            --I.x;
        } else if (I.x < player.x) {
            ++I.x;
        }
        if (I.y > player.y) {
            --I.y;
        } else if (I.y < player.y) {
            ++I.y;
        }

        I.xVelocity = 3 * Math.sin(I.age * Math.PI / 64);

        I.age++;

        I.active = I.active && I.inBounds();
    };

    I.explode = function () {
        Sound.play("explosion");

        this.active = false;
        // Extra Credit: Add an explosion graphic
    };

    return I;
}

var canvasElement = $("<canvas width='" + CANVAS_WIDTH +
        "' height='" + CANVAS_HEIGHT + "'></canvas");
var canvas = canvasElement.get(0).getContext("2d");
canvasElement.appendTo('body');

setInterval(function () {
    update();
    draw();
}, 1000 / FPS);

function update() {
    if (keydown.space) {
        player.shoot();
    }

    if (keydown.left) {
        player.x -= 5;
        if (player.oldSprite !== PLAYER_LEFT) {
            player.sprite = Sprite(PLAYER_LEFT);
            player.width = 53;
            player.height = 38;
            player.oldSprite = PLAYER_LEFT;
        }
    }

    if (keydown.right) {
        player.x += 5;
        if (player.oldSprite !== PLAYER_RIGHT) {
            player.sprite = Sprite(PLAYER_RIGHT);
            player.width = 53;
            player.height = 38;
            player.oldSprite = PLAYER_RIGHT;
        }
    }

    if (keydown.up) {
        player.y -= 5;
        if (player.oldSprite !== PLAYER_UP) {
            player.sprite = Sprite(PLAYER_UP);
            player.width = 38;
            player.height = 53;
            player.oldSprite = PLAYER_UP;
        }
    }

    if (keydown.down) {
        player.y += 5;
        if (player.oldSprite !== PLAYER_DOWN) {
            player.sprite = Sprite(PLAYER_DOWN);
            player.width = 38;
            player.height = 53;
            player.oldSprite = PLAYER_DOWN;
        }
    }

    player.x = player.x.clamp(0, CANVAS_WIDTH - player.width);
    player.y = player.y.clamp(0, CANVAS_HEIGHT - player.height);

    playerBullets.forEach(function (bullet) {
        bullet.update();
    });

    playerBullets = playerBullets.filter(function (bullet) {
        return bullet.active;
    });

    enemies.forEach(function (enemy) {
        enemy.update();
    });

    enemies = enemies.filter(function (enemy) {
        return enemy.active;
    });

    handleCollisions();
    if (Math.random() < 0.05) {
        enemies.push(Enemy());
    }
}

player.shoot = function () {
    Sound.play("shoot");

    var bulletPosition = this.gunPoint(player.oldSprite);

    playerBullets.push(Bullet({
        speed:5,
        x:bulletPosition.x,
        y:bulletPosition.y
    }));
};

player.gunPoint = function (playerPosition) {
    if (playerPosition == PLAYER_UP) {
        return {
            x:this.x + this.width / .5,
            y:this.y + this.height / 2
        };
    } else if (playerPosition == PLAYER_DOWN) {
        return {
            x:this.width - this.width / 2,
            y:this.y - this.height / 2
        };
    } else if (playerPosition == PLAYER_RIGHT) {
        return {
            x:this.x + this.width / 2,
            y:this.y + this.height / 2
        };
    } else if (playerPosition == PLAYER_LEFT) {
        return {
            x:this.x + this.width / 2,
            y:this.y + this.height / 2
        };
    }
};

function draw() {
    canvas.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
    player.draw();

    playerBullets.forEach(function (bullet) {
        bullet.draw();
    });

    enemies.forEach(function (enemy) {
        enemy.draw();
    });
}

function collides(a, b) {
    return a.x < b.x + b.width &&
            a.x + a.width > b.x &&
            a.y < b.y + b.height &&
            a.y + a.height > b.y;
}

function handleCollisions() {
    playerBullets.forEach(function (bullet) {
        enemies.forEach(function (enemy) {
            if (collides(bullet, enemy)) {
                enemy.explode();
                bullet.active = false;
            }
        });
    });

    enemies.forEach(function (enemy) {
        if (collides(enemy, player)) {
            enemy.explode();
            player.explode();
        }
    });
}

player.explode = function () {
    this.active = false;
    // Extra Credit: Add an explosion graphic and then end the game
};

player.sprite = Sprite(PLAYER_UP);
player.oldSprite = PLAYER_UP;
player.draw = function () {
    this.sprite.draw(canvas, this.x, this.y);
};
//]]>
</script>
</body>
</html>
