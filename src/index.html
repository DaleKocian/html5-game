<!DOCTYPE html>
<html>
<head>
    <title>SADC Game Demo</title>
    <link href="css/screen.css" media="all" rel="stylesheet" type="text/css"/>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script language="javascript" src="js/jquery.hotkeys.js" type="text/javascript"></script>
    <script language="javascript" src="js/key_status.js" type="text/javascript"></script>
    <script language="javascript" src="js/util.js" type="text/javascript"></script>
    <script language="javascript" src="js/sprite.js" type="text/javascript"></script>
    <script language="javascript" src="js/sound.js" type="text/javascript"></script>
</head>
<body>
<div id="start-screen">
    <div id="start-button">
        Start Game
    </div>
</div>
<div id="character-select-screen">
    <h1>Select Your Character</h1>
    <img id="dale" src="img/dale.png"/>
    <img id="triest" src="img/triest.png"/>
</div>
<div id="game">
    <div id="wave">Wave 1</div>
    <div id="resume-pause">
        Pause
    </div>
    <canvas id="canvasBg" width="1270" height="687">
    </canvas>
    <div class="playerMenuItem" id="score">Score:</div>
    <div class="playerMenuItem" id="lives">Lives:</div>
    <div class="playerMenuItem" id="health">Health: 10</div>
</div>
<script type="text/javascript">
//<![CDATA[
$('#start-button').on('click', function () {
    $(this).parent().hide("slow");
    $('#character-select-screen').show("slow");
});
$('#dale, #triest').on('click', function () {
    var id = $(this).prop('id');
    switch (id) {
        case 'dale':
            console.log('You selected Dale!');
            break;
        case 'triest':
            console.log('You selected Triest!');
            break;
    }
    $('#character-select-screen').hide('slow');
    $('#game').show('slow');
    startGame()
});

var canvasElement = $('#canvasBg');
var canvas = canvasElement.get(0).getContext("2d");
var CANVAS_WIDTH = canvasElement.attr('width');
var CANVAS_HEIGHT = canvasElement.attr('height');
var FPS = 30;
var PLAYER_UP = "player-up";
var PLAYER_DOWN = "player-down";
var PLAYER_LEFT = "player-left";
var PLAYER_RIGHT = "player-right";
var SCORE = 0;
var HEALTH = 10;
var STRAFE_MODE = false;


var player = {
    color:"#00A",
    x:635,
    y:343.5,
    width:38,
    height:53,
    draw:function () {
        canvas.fillStyle = this.color;
        canvas.fillRect(this.x, this.y, this.width, this.height);
    }
};

var playerBullets = [];

function Bullet(I) {
    I.active = true;
    determineBulletDirection(I, player.oldSprite);
    I.width = 3;
    I.height = 3;
    I.color = "#000";

    I.inBounds = function () {
        return I.x >= 0 && I.x <= CANVAS_WIDTH &&
                I.y >= 0 && I.y <= CANVAS_HEIGHT;
    };

    I.draw = function () {
        canvas.fillStyle = this.color;
        canvas.fillRect(this.x, this.y, this.width, this.height);
    };

    I.update = function () {
        I.x += I.xVelocity;
        I.y += I.yVelocity;

        I.active = I.active && I.inBounds();
    };

    I.explode = function () {
        this.active = false;
        // Extra Credit: Add an explosion graphic
    };

    return I;
}

function determineBulletDirection(I, playerPosition) {
    if (playerPosition == PLAYER_UP) {
        I.xVelocity = 0;
        I.yVelocity = -I.speed;
    } else if (playerPosition == PLAYER_DOWN) {
        I.xVelocity = 0;
        I.yVelocity = I.speed;
    } else if (playerPosition == PLAYER_LEFT) {
        I.xVelocity = -I.speed;
        I.yVelocity = 0;
    } else if (playerPosition == PLAYER_RIGHT) {
        I.xVelocity = I.speed;
        I.yVelocity = 0;
    }
}

enemies = [];

function setEnemyStartingPoint(I) {
    var r = Math.floor(Math.random() * 4) + 1;
    I.x = CANVAS_WIDTH / 4 + Math.random() * CANVAS_WIDTH / 2;
    I.y = CANVAS_HEIGHT / 4 + Math.random() * CANVAS_HEIGHT / 2;
    switch (r) {
        case 1:
            I.y = 0;
            break;
        case 2:
            I.x = 0;
            break;
        case 3:
            I.x = CANVAS_WIDTH;
            break;
        default:
            I.y = CANVAS_HEIGHT;
            break
    }
    return I;
}

function Enemy(I) {
    I = I || {};

    I.active = true;
    I.age = Math.floor(Math.random() * 128);

    I.color = "#A2B";

    setEnemyStartingPoint(I);

    I.xVelocity = 0;
    I.yVelocity = 2;

    I.width = 32;
    I.height = 75;

    I.inBounds = function () {
        return I.x >= 0 && I.x <= CANVAS_WIDTH &&
                I.y >= 0 && I.y <= CANVAS_HEIGHT;
    };

    I.sprite = Sprite("enemy");

    I.draw = function () {
        this.sprite.draw(canvas, this.x, this.y);
    };

    I.update = function () {
        if (I.x > player.x) {
            --I.x;
        } else if (I.x < player.x) {
            ++I.x;
        }
        if (I.y > player.y) {
            --I.y;
        } else if (I.y < player.y) {
            ++I.y;
        }

        I.xVelocity = 3 * Math.sin(I.age * Math.PI / 64);

        I.age++;

        I.active = I.active && I.inBounds();
    };

    I.explode = function () {
        Sound.play("explosion");

        this.active = false;
        // Extra Credit: Add an explosion graphic
    };

    return I;
}
var refreshIntervalId;

function startGame() {
    refreshIntervalId = setInterval(function () {
        update();
        draw();
    }, 1000 / FPS);
}
function pauseGame() {
    clearInterval(refreshIntervalId);
}

function resetGame() {
    clearInterval(refreshIntervalId);
    canvas.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
}

function update() {

    if (keydown.space) {
        player.shoot();
    }

    if (keydown.shift) {
        STRAFE_MODE = true;
    }

    if (keydown.ctrl) {
        STRAFE_MODE = false;
    }

    if (keydown.left) {
        player.x -= 5;
        if (player.oldSprite !== PLAYER_LEFT && !STRAFE_MODE) {
            player.sprite = Sprite(PLAYER_LEFT);
            player.width = 53;
            player.height = 38;
            player.oldSprite = PLAYER_LEFT;
        }
    }

    if (keydown.right) {
        player.x += 5;
        if (player.oldSprite !== PLAYER_RIGHT && !STRAFE_MODE) {
            player.sprite = Sprite(PLAYER_RIGHT);
            player.width = 53;
            player.height = 38;
            player.oldSprite = PLAYER_RIGHT;
        }
    }

    if (keydown.up) {
        player.y -= 5;
        if (player.oldSprite !== PLAYER_UP && !STRAFE_MODE) {
            player.sprite = Sprite(PLAYER_UP);
            player.width = 38;
            player.height = 53;
            player.oldSprite = PLAYER_UP;
        }
    }

    if (keydown.down) {
        player.y += 5;
        if (player.oldSprite !== PLAYER_DOWN && !STRAFE_MODE) {
            player.sprite = Sprite(PLAYER_DOWN);
            player.width = 38;
            player.height = 53;
            player.oldSprite = PLAYER_DOWN;
        }

//        if(keydown.down && keydown.right){
//
//        }
    }



    player.x = player.x.clamp(0, CANVAS_WIDTH - player.width);
    player.y = player.y.clamp(20, CANVAS_HEIGHT - player.height);

    playerBullets.forEach(function (bullet) {
        bullet.update();
    });

    playerBullets = playerBullets.filter(function (bullet) {
        return bullet.active;
    });

    enemies.forEach(function (enemy) {
        enemy.update();
    });

    enemies = enemies.filter(function (enemy) {
        return enemy.active;
    });

    handleCollisions();
    if (Math.random() < 0.05) {
        enemies.push(Enemy());
    }
}

player.shoot = function () {
    Sound.play("shoot");

    var bulletPosition = this.gunPoint(player.oldSprite);

    playerBullets.push(Bullet({
        speed:5,
        x:bulletPosition.x,
        y:bulletPosition.y
    }));
};

player.gunPoint = function (playerPosition) {
    if (playerPosition == PLAYER_UP) {
        return {
            x:this.x + this.width - 11,
            y:( this.y + this.height / 12 ) - 4
        };
    } else if (playerPosition == PLAYER_DOWN) {
        return {
            x:this.x + this.width - 11,
            y:( this.y + this.height / 12 ) + 44
        };
    } else if (playerPosition == PLAYER_RIGHT) {
        return {
            x:(this.x + this.width / 2) + 24,
            y:(this.y + this.height / 2) + 8
        };
    } else if (playerPosition == PLAYER_LEFT) {
        return {
            x:(this.x + this.width / 2) - 26,
            y:(this.y + this.height / 2) + 8
        };
    }
};

function draw() {
    canvas.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
    player.draw();

    playerBullets.forEach(function (bullet) {
        bullet.draw();
    });

    enemies.forEach(function (enemy) {
        enemy.draw();
    });
}

function collides(a, b) {
    return a.x < b.x + b.width &&
            a.x + a.width > b.x &&
            a.y < b.y + b.height &&
            a.y + a.height > b.y;
}

function handleCollisions() {
    playerBullets.forEach(function (bullet) {
        enemies.forEach(function (enemy) {
            if (collides(bullet, enemy)) {
                enemy.explode();
                bullet.active = false;
                updateScore();
            }
        });
    });

    enemies.forEach(function (enemy) {
        if (collides(enemy, player)) {
            enemy.explode();
            player.explode();
            reduceHealth();
        }
    });
}

player.explode = function () {
    this.active = false;
    // Extra Credit: Add an explosion graphic and then end the game
};

player.sprite = Sprite(PLAYER_UP);
player.oldSprite = PLAYER_UP;
player.draw = function () {
    this.sprite.draw(canvas, this.x, this.y);
};

function updateScore() {
    SCORE++;
    $('#score').text("Score: " + SCORE);
}
function reduceHealth() {
    if (HEALTH > 0) {
        HEALTH--;
    }
    $('#health').text("Health: " + HEALTH)
}

$('#resume-pause').toggle(function () {
    pauseGame();
    $(this).text('Resume');
}, function () {
    startGame();
    $(this).text('Pause');
});
$('body').keypress(function() {
    if (keydown.p) {
        var $el = $('#resume-pause');
        if ($el.text() === 'Resume') {
            startGame();
            $el.text('Pause');
        } else {
            pauseGame();
            $el.text('Resume');
        }
    }
});
//]]>
</script>
</body>
</html>



